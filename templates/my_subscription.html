{% extends "layout.html" %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Tilaukseni</h1>
    
    <!-- Flash messages -->
    {% for category, message in get_flashed_messages(with_categories=true) %}
    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    
    <!-- Active subscription -->
    {% if subscription and subscription.is_active() %}
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0">Aktiivinen tilaus</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <h5>{{ subscription.product.name }}</h5>
                    <p class="text-muted">Tilaustunnus: {{ subscription.id }}</p>
                    
                    <div class="mb-3">
                        <strong>Tila:</strong> 
                        <span class="badge bg-success">Aktiivinen</span>
                        {% if subscription.cancel_at_period_end %}
                        <span class="badge bg-warning">Päättyy laskutuskauden lopussa</span>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <strong>Tilaustyyppi:</strong> 
                        {% if subscription.subscription_type == 'monthly' %}
                        Kuukausitilaus
                        {% else %}
                        {{ subscription.subscription_type }}
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <strong>Voimassa:</strong> {{ subscription.created_at.strftime('%d.%m.%Y') }} - {{ subscription.expires_at.strftime('%d.%m.%Y') }}
                    </div>
                    
                    {% if subscription.next_billing_date %}
                    <div class="mb-3">
                        <strong>Seuraava laskutuspäivä:</strong> {{ subscription.next_billing_date.strftime('%d.%m.%Y') }}
                    </div>
                    {% endif %}
                    
                    <div class="mb-3">
                        <strong>Hinta:</strong> {{ subscription.product.price }}€ / kuukausi
                    </div>
                </div>
                
                <div class="col-md-4">
                    <!-- Subscription actions -->
                    <div class="d-grid gap-2">
                        {% if subscription.cancel_at_period_end %}
                        <!-- Option to undo cancellation -->
                        <a href="{{ url_for('renew_subscription', subscription_id=subscription.id) }}" class="btn btn-success">
                            <i class="fas fa-redo-alt"></i> Jatka tilausta
                        </a>
                        {% else %}
                        <!-- Cancel subscription button - opens modal -->
                        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#cancelSubscriptionModal">
                            <i class="fas fa-times-circle"></i> Peruuta tilaus
                        </button>
                        {% endif %}
                        
                        <!-- Renew subscription now button -->
                        <a href="{{ url_for('renew_subscription', subscription_id=subscription.id) }}" class="btn btn-primary">
                            <i class="fas fa-sync-alt"></i> Uusi tilaus nyt
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Cancel Subscription Modal -->
    <div class="modal fade" id="cancelSubscriptionModal" tabindex="-1" aria-labelledby="cancelSubscriptionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="cancelSubscriptionModalLabel">Vahvista tilauksen peruutus</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Oletko varma, että haluat peruuttaa tilauksesi?</p>
                    
                    <form id="cancelSubscriptionForm" action="{{ url_for('process_subscription_cancellation') }}" method="POST">
                        <input type="hidden" name="subscription_id" value="{{ subscription.id }}">
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="cancel_type" id="cancelAtPeriodEnd" value="period_end" checked>
                            <label class="form-check-label" for="cancelAtPeriodEnd">
                                Peruuta laskutuskauden lopussa ({{ subscription.expires_at.strftime('%d.%m.%Y') }})
                            </label>
                            <small class="form-text text-muted d-block">Voit käyttää palvelua laskutuskauden loppuun asti.</small>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="cancel_type" id="cancelImmediately" value="immediate">
                            <label class="form-check-label" for="cancelImmediately">
                                Peruuta välittömästi
                            </label>
                            <small class="form-text text-muted d-block">Tilaus päättyy heti, etkä voi enää käyttää palvelua.</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Peruuta</button>
                    <button type="button" class="btn btn-danger" onclick="document.getElementById('cancelSubscriptionForm').submit();">
                        Vahvista peruutus
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Payment History -->
    {% if payments %}
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            <h5 class="card-title mb-0">Maksuhistoria</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Päivämäärä</th>
                            <th>Summa</th>
                            <th>Maksutapa</th>
                            <th>Tila</th>
                            <th>Tapahtuma-ID</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for payment in payments %}
                        <tr>
                            <td>{{ payment.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                            <td>{{ payment.amount }}€</td>
                            <td>{{ payment.payment_method }}</td>
                            <td>
                                {% if payment.status == 'completed' %}
                                <span class="badge bg-success">Maksettu</span>
                                {% elif payment.status == 'pending' %}
                                <span class="badge bg-warning">Odottaa</span>
                                {% elif payment.status == 'failed' %}
                                <span class="badge bg-danger">Epäonnistui</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ payment.status }}</span>
                                {% endif %}
                            </td>
                            <td>{{ payment.transaction_id }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% elif subscription and not subscription.is_active() %}
    <!-- Inactive subscription -->
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            <h5 class="card-title mb-0">Päättynyt tilaus</h5>
        </div>
        <div class="card-body">
            <p>Tilauksesi on päättynyt. Voit aktivoida uuden tilauksen alla olevista vaihtoehdoista.</p>
            
            <div class="mb-3">
                <strong>Tila:</strong> 
                {% if subscription.status == 'cancelled' %}
                <span class="badge bg-secondary">Peruutettu</span>
                {% elif subscription.status == 'expired' %}
                <span class="badge bg-secondary">Vanhentunut</span>
                {% elif subscription.status == 'payment_failed' %}
                <span class="badge bg-danger">Maksu epäonnistui</span>
                {% else %}
                <span class="badge bg-secondary">{{ subscription.status }}</span>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <strong>Päättymispäivä:</strong> {{ subscription.expires_at.strftime('%d.%m.%Y') }}
            </div>
            
            <!-- Reactivate button -->
            <a href="{{ url_for('renew_subscription', subscription_id=subscription.id) }}" class="btn btn-success">
                <i class="fas fa-redo-alt"></i> Aktivoi tilaus uudelleen
            </a>
        </div>
    </div>
    {% else %}
    <!-- No subscription -->
    <div class="alert alert-info">
        <h4 class="alert-heading">Ei aktiivista tilausta</h4>
        <p>Sinulla ei ole aktiivista tilausta tällä hetkellä. Valitse alla olevista vaihtoehdoista sinulle sopivin tilaus.</p>
    </div>
    {% endif %}
    
    <!-- Available Subscription Products -->
    {% if subscription_products %}
    <h2 class="mb-3 mt-4">Saatavilla olevat tilaukset</h2>
    
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-4">
        {% for product in subscription_products %}
        <div class="col">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">{{ product.name }}</h5>
                </div>
                <div class="card-body">
                    <h6 class="card-price text-center">{{ product.price }}€ <span class="period">/kuukausi</span></h6>
                    <p class="card-text">{{ product.description }}</p>
                    <ul class="list-unstyled mb-4">
                        <li><i class="fas fa-check text-success me-2"></i>Rajaton määrä analyysejä</li>
                        <li><i class="fas fa-check text-success me-2"></i>30 päivän tilausjakso</li>
                        <li><i class="fas fa-check text-success me-2"></i>Peruutettavissa milloin tahansa</li>
                    </ul>
                </div>
                <div class="card-footer">
                    <div class="d-grid">
                        <a href="{{ url_for('checkout_paytrail', product_id=product.id) }}" class="btn btn-primary">
                            Tilaa nyt
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endblock %} 