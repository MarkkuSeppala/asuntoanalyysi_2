{% extends "base_authenticated.html" %}

{% block title %}Kotolyysi{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #F1EFEC;
        --secondary-color: #D4C9BE;
        --accent-color: #123458;
        --accent-hover: #1a4b7c;
        --neutral-color: #030303;
        --light-bg: #f9f9f9;
        --card-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
        --card-hover-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        --card-radius: 16px;
        --transition-normal: all 0.3s ease;
    }
    
    body {
        font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif;
        color: var(--neutral-color);
        background-color: var(--primary-color);
        line-height: 1.6;
    }
    
    /* Hero section */
    .hero-section {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        padding: 100px 0 120px;
        margin-bottom: 70px;
        color: var(--neutral-color);
        position: relative;
        overflow: hidden;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
    }
    
    .hero-section::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 60%;
        height: 100%;
        background-image: url('https://images.unsplash.com/photo-1560518883-ce09059eeffa?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1073&q=80');
        background-size: cover;
        background-position: center;
        opacity: 0.1;
        z-index: 0;
    }
    
    .hero-section::after {
        content: '';
        position: absolute;
        bottom: -50px;
        left: 0;
        width: 100%;
        height: 100px;
        background-color: var(--primary-color);
        transform: skewY(-3deg);
        z-index: 1;
    }
    
    .hero-title {
        font-size: 3.2rem;
        font-weight: 800;
        margin-bottom: 25px;
        line-height: 1.2;
        color: var(--neutral-color);
        animation: fadeInUp 0.8s ease-out;
    }
    
    .hero-subtitle {
        font-size: 1.5rem;
        font-weight: 400;
        margin-bottom: 30px;
        opacity: 0.9;
        color: var(--neutral-color);
        max-width: 600px;
        animation: fadeInUp 1s ease-out;
    }
    
    .accent-text {
        color: var(--accent-color);
        position: relative;
    }
    
    .accent-text::after {
        content: '';
        position: absolute;
        bottom: -5px;
        left: 0;
        width: 100%;
        height: 3px;
        background-color: var(--accent-color);
        opacity: 0.3;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Form card */
    .form-card {
        background-color: white;
        border-radius: var(--card-radius);
        border: none;
        overflow: hidden;
        box-shadow: var(--card-shadow);
        transition: var(--transition-normal);
        margin-bottom: 40px;
        border-bottom: 4px solid transparent;
        position: relative;
    }
    
    .form-card:hover {
        transform: translateY(-7px);
        box-shadow: var(--card-hover-shadow);
        border-bottom: 4px solid var(--accent-color);
    }
    
    .form-header {
        background: white;
        color: var(--accent-color);
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        font-weight: 700;
        padding: 25px 30px;
        position: relative;
    }
    
    .form-header::after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 30px;
        width: 50px;
        height: 3px;
        background-color: var(--accent-color);
    }
    
    .form-body {
        padding: 35px;
    }
    
    /* Form elements */
    .url-input {
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        font-size: 1.1rem;
        padding: 14px 18px;
        transition: var(--transition-normal);
        font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05) inset;
    }
    
    .url-input:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px rgba(18, 52, 88, 0.15);
        outline: none;
    }
    
    .form-label {
        font-weight: 600;
        color: #444;
        margin-bottom: 10px;
    }
    
    .btn-accent {
        background-color: var(--accent-color);
        color: white;
        padding: 14px 30px;
        border-radius: 12px;
        font-weight: 600;
        transition: var(--transition-normal);
        border: none;
        letter-spacing: 0.3px;
        position: relative;
        overflow: hidden;
    }
    
    .btn-accent::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: all 0.6s ease;
    }
    
    .btn-accent:hover {
        background-color: var(--accent-hover);
        color: white;
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(18, 52, 88, 0.2);
    }
    
    .btn-accent:hover::before {
        left: 100%;
    }
    
    /* Info card */
    .info-card {
        background-color: white;
        border-radius: var(--card-radius);
        box-shadow: var(--card-shadow);
        border: none;
        overflow: hidden;
        transition: var(--transition-normal);
        border-bottom: 4px solid transparent;
        height: 100%;
    }
    
    .info-card:hover {
        transform: translateY(-7px);
        box-shadow: var(--card-hover-shadow);
        border-bottom: 4px solid var(--accent-color);
    }
    
    .info-header {
        background: white;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        font-weight: 700;
        color: var(--accent-color);
        padding: 25px 30px;
        position: relative;
    }
    
    .info-header::after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 30px;
        width: 50px;
        height: 3px;
        background-color: var(--accent-color);
    }
    
    .info-body {
        padding: 35px;
    }
    
    /* Steps list - modernimpi vaihelistaus */
    .steps-list {
        counter-reset: step-counter;
        list-style: none;
        padding-left: 0;
    }
    
    .step-item {
        position: relative;
        padding-left: 70px;
        margin-bottom: 30px;
        min-height: 50px;
        display: flex;
        align-items: center;
        transition: transform 0.3s ease;
    }
    
    .step-item:hover {
        transform: translateX(5px);
    }
    
    .step-item:last-child {
        margin-bottom: 0;
    }
    
    .step-item:before {
        content: counter(step-counter);
        counter-increment: step-counter;
        position: absolute;
        left: 0;
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.3rem;
        box-shadow: 0 5px 15px rgba(18, 52, 88, 0.2);
        transition: all 0.3s ease;
    }
    
    .step-item:hover:before {
        transform: scale(1.1);
        box-shadow: 0 8px 20px rgba(18, 52, 88, 0.3);
    }
    
    /* Table styling */
    .table {
        width: 100%;
        margin-bottom: 0;
        color: var(--neutral-color);
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .table thead th {
        border-bottom: 2px solid var(--accent-color);
        border-top: none;
        font-weight: 600;
        color: var(--accent-color);
        padding: 12px;
    }
    
    .table td {
        padding: 12px;
        vertical-align: middle;
        border-top: 1px solid rgba(0,0,0,0.05);
        transition: all 0.2s ease;
    }
    
    .table tbody tr {
        transition: all 0.2s ease;
    }
    
    .table tbody tr:hover {
        background-color: rgba(18, 52, 88, 0.03);
        transform: translateY(-1px);
    }
    
    .table a {
        color: var(--accent-color);
        transition: all 0.2s ease;
    }
    
    .table a:hover {
        color: var(--accent-hover);
        text-decoration: none;
    }
    
    .btn-sm {
        padding: 0.4rem 0.8rem;
        font-size: 0.875rem;
        border-radius: 0.5rem;
    }
    
    .btn-outline-primary {
        color: var(--accent-color);
        border-color: var(--accent-color);
    }
    
    .btn-outline-primary:hover {
        background-color: var(--accent-color);
        border-color: var(--accent-color);
        transform: translateY(-1px);
        box-shadow: 0 4px 10px rgba(18, 52, 88, 0.15);
    }
    
    /* Drag and drop styles */
    .drag-drop-area {
        border: 2px dashed #ccc;
        border-radius: 15px;
        padding: 35px 20px;
        text-align: center;
        cursor: pointer;
        transition: var(--transition-normal);
        background-color: var(--light-bg);
        margin-top: 15px;
    }
    
    .drag-drop-area.dragover {
        border-color: var(--accent-color);
        background-color: rgba(18, 52, 88, 0.05);
        transform: scale(1.01);
    }
    
    .drag-drop-icon {
        font-size: 2.5rem;
        color: var(--accent-color);
        margin-bottom: 15px;
        transition: all 0.3s ease;
        opacity: 0.7;
    }
    
    .drag-drop-area:hover .drag-drop-icon {
        transform: translateY(-5px);
        opacity: 1;
    }
    
    .drag-drop-text {
        font-weight: 600;
        color: #444;
        margin-bottom: 8px;
    }
    
    .drag-drop-subtext {
        color: #777;
        margin-bottom: 0;
    }
    
    .drag-drop-subtext .text-primary {
        font-weight: 600;
    }
    
    .file-preview {
        display: flex;
        align-items: center;
        background-color: var(--light-bg);
        border-radius: 12px;
        padding: 15px 20px;
        margin-top: 20px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.03);
        animation: fadeIn 0.3s ease;
    }
    
    .file-preview-icon {
        font-size: 1.5rem;
        color: var(--accent-color);
        margin-right: 15px;
    }
    
    .file-preview-info {
        flex-grow: 1;
    }
    
    .file-preview-name {
        font-weight: 600;
        margin-bottom: 3px;
        color: #444;
    }
    
    .file-preview-size {
        color: #777;
        font-size: 0.85rem;
        margin-bottom: 0;
    }
    
    .file-preview-remove {
        color: #777;
        cursor: pointer;
        transition: color 0.2s ease;
        padding: 5px;
    }
    
    .file-preview-remove:hover {
        color: #dc3545;
    }
    
    /* Loading animation */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.97);
        backdrop-filter: blur(5px);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition: all 0.4s ease;
    }
    
    .loading-overlay.show {
        opacity: 1;
        visibility: visible;
    }
    
    .loading-spinner {
        width: 90px;
        height: 90px;
        border: 10px solid var(--primary-color);
        border-top: 10px solid var(--accent-color);
        border-radius: 50%;
        animation: spin 1.2s linear infinite;
        margin-bottom: 35px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .loading-text {
        color: var(--accent-color);
        font-size: 1.6rem;
        font-weight: 600;
        margin-bottom: 12px;
        animation: pulse 2s infinite;
    }
    
    .loading-subtext {
        color: var(--neutral-color);
        text-align: center;
        max-width: 450px;
        opacity: 0.8;
        line-height: 1.6;
    }
    
    .loading-progress-container {
        width: 350px;
        height: 12px;
        background-color: var(--primary-color);
        border-radius: 6px;
        margin-top: 25px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05) inset;
    }
    
    .loading-progress-bar {
        height: 100%;
        width: 0;
        background: linear-gradient(90deg, var(--accent-color), var(--accent-hover));
        animation: progressAnimation 30s linear forwards;
        border-radius: 6px;
    }
    
    /* Error states */
    .url-input.is-invalid {
        border-color: #dc3545;
        box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.15);
    }
    
    .url-error {
        display: none;
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 0.7rem;
        padding-left: 0.5rem;
        font-weight: 500;
        opacity: 0;
    }
    
    .url-error.show {
        display: block;
        animation: fadeInErrorMessage 0.4s ease forwards;
    }
    
    /* Animations */
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    @keyframes pulse {
        0% { opacity: 0.8; }
        50% { opacity: 1; }
        100% { opacity: 0.8; }
    }
    
    @keyframes progressAnimation {
        0% { width: 0; }
        90% { width: 90%; }
        100% { width: 100%; }
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes fadeInErrorMessage {
        from { 
            opacity: 0;
            transform: translateY(-10px);
        }
        to { 
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Responsive adjustments */
    @media (max-width: 1200px) {
        .hero-title {
            font-size: 2.8rem;
        }
    }
    
    @media (max-width: 992px) {
        .hero-title {
            font-size: 2.5rem;
        }
        
        .hero-subtitle {
            font-size: 1.3rem;
        }
        
        .form-header, .info-header {
            padding: 20px 25px;
        }
        
        .form-body, .info-body {
            padding: 25px;
        }
    }
    
    @media (max-width: 768px) {
        .hero-section {
            padding: 70px 0 90px;
        }
        
        .hero-title {
            font-size: 2.2rem;
        }
        
        .hero-subtitle {
            font-size: 1.15rem;
        }
        
        .form-header, .info-header {
            padding: 18px 20px;
        }
        
        .form-body, .info-body {
            padding: 20px;
        }
        
        .step-item {
            padding-left: 60px;
            margin-bottom: 25px;
        }
        
        .step-item:before {
            width: 45px;
            height: 45px;
            font-size: 1.2rem;
        }
        
        .loading-progress-container {
            width: 90%;
            max-width: 320px;
        }
        
        .loading-text {
            font-size: 1.4rem;
        }
        
        .loading-subtext {
            font-size: 0.95rem;
            padding: 0 20px;
        }
    }
    
    @media (max-width: 576px) {
        .hero-section {
            padding: 50px 0 70px;
        }
        
        .hero-title {
            font-size: 1.9rem;
        }
        
        .hero-subtitle {
            font-size: 1.05rem;
        }
        
        .btn-accent {
            padding: 12px 20px;
        }
        
        .table th, .table td {
            padding: 10px 8px;
            font-size: 0.9rem;
        }
        
        .btn-sm {
            padding: 0.3rem 0.6rem;
            font-size: 0.8rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section">
    <div class="container">
        <div class="container">
            <div class="row g-4">
                <!-- Form column -->
                <div class="col-lg-7 mb-4">
                    <div class="form-card">
                        <div class="form-header">
                            <h4 class="mb-0"><i class="fas fa-link me-2"></i>Syötä asuntoilmoituksen URL</h4>
                        </div>
                        <div class="form-body">
                            <form id="analyze-form" action="{{ url_for('analyze') }}" method="post">
                                <div class="mb-4">
                                    <label for="url" class="form-label">Asuntoilmoituksen URL-osoite</label>
                                    <input 
                                        type="url" 
                                        class="form-control url-input" 
                                        id="url" 
                                        name="url" 
                                        placeholder="https://asunnot.oikotie.fi/... tai https://www.etuovi.com/..."
                                        required
                                    >
                                    <div id="url-error" class="url-error">Syötä kelvollinen Oikotie- tai Etuovi-asuntoilmoituksen URL.</div>
                                </div>
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-accent" id="submit-btn">
                                        <i class="fas fa-search-location me-2"></i>Analysoi kohde
                                    </button>
                                </div>
                                <div class="mt-3">
                                    <p class="small text-muted mb-0">Tuemme tällä hetkellä Oikotien ja Etuovin asuntoilmoituksia.</p>
                                </div>
                            </form>
                            
                            <div class="mt-4 pt-3 border-top">
                                <h5><i class="fas fa-file-upload me-2"></i>Tai lataa PDF-tiedosto suoraan</h5>
                                <div id="drag-drop-area" class="drag-drop-area">
                                    <input type="file" id="file-input" accept=".pdf" style="display: none;">
                                    <div class="drag-drop-icon">
                                        <i class="fas fa-file-pdf"></i>
                                    </div>
                                    <p class="drag-drop-text">Raahaa ja pudota PDF-tiedosto tähän</p>
                                    <p class="drag-drop-subtext">tai <span class="text-primary">selaa tiedostoja</span></p>
                                    <p class="drag-drop-subtext mt-2">Hyväksytään Etuovi ja Oikotie PDF-esitteet</p>
                                </div>
                                <div id="file-preview" style="display: none;" class="file-preview">
                                    <span class="file-preview-icon"><i class="fas fa-file-pdf"></i></span>
                                    <div class="file-preview-info">
                                        <p class="file-preview-name" id="file-name"></p>
                                        <p class="file-preview-size" id="file-size"></p>
                                    </div>
                                    <span class="file-preview-remove" id="file-remove"><i class="fas fa-times"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Instructions column - siirretty oikealle puolelle -->
                <div class="col-lg-5 mb-4">
                    <div class="info-card">
                        <div class="info-header">
                            <h4 class="mb-0"><i class="fas fa-info-circle me-2"></i>Ohjeita analyysin tekemiseen</h4>
                        </div>
                        <div class="info-body">
                            <h5 class="mb-3">Vaihtoehto 1: Anna verkko-osoite</h5>
                            <ol class="mb-4">
                                <li class="mb-2">Kopioi asuntoilmoituksen URL-osoite <strong>Oikotie.fi</strong> tai <strong>Etuovi.com</strong> -sivustolta</li>
                                <li class="mb-2">Liitä osoite vasemman puolen kenttään</li>
                                <li class="mb-2">Paina "<strong>Analysoi kohde</strong>" -painiketta</li>
                                <li class="mb-2">Analyysi kestää noin 1-2 minuuttia</li>
                            </ol>
                            
                            <h5 class="mb-3">Vaihtoehto 2: Lataa PDF</h5>
                            <ol class="mb-4">
                                <li class="mb-2">Lataa asunnon myynti-ilmoitus Oikotieltä tai Etuovesta PDF-muodossa</li>
                                <li class="mb-2">Raahaa asuntoilmoituksen PDF-tiedosto latausalueelle</li>
                                <li class="mb-2">Vaihtoehtoisesti klikkaa aluetta ja valitse tiedosto laitteeltasi</li>
                                <li class="mb-2">Analyysi käynnistyy automaattisesti tiedoston valinnan jälkeen</li>
                                <li class="mb-2">Analyysi kestää noin 1-2 minuuttia</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
    </div>
</section>


    
    <!-- Recent analyses row - siirretty omalle rivilleen -->
    <div class="row">
        <div class="col-12 mb-5">
            <div class="info-card">
                <div class="info-header">
                    <h4 class="mb-0"><i class="fas fa-history me-2"></i>Viimeisimmät analyysisi</h4>
                </div>
                <div class="info-body">
                    {% if analyses|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Osoite</th>
                                    <th>Päivämäärä</th>
                                    <th>Kokonaisriski</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for analysis in analyses %}
                                <tr>
                                    <td>
                                        {% if analysis.kohde and analysis.kohde.osoite %}
                                            <a href="{{ url_for('view_analysis', analysis_id=analysis.id) }}" class="text-decoration-none">{{ analysis.kohde.osoite }}</a>
                                        {% else %}
                                            <a href="{{ url_for('view_analysis', analysis_id=analysis.id) }}" class="text-decoration-none">{{ analysis.title }}</a>
                                        {% endif %}
                                    </td>
                                    <td>{{ analysis.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                                    <td>
                                        {% if analysis.risk_analysis and analysis.risk_analysis.kokonaisriskitaso %}
                                            <span class="badge {% if analysis.risk_analysis.kokonaisriskitaso <= 3.4 %}bg-success{% elif analysis.risk_analysis.kokonaisriskitaso <= 5.5 %}bg-warning{% elif analysis.risk_analysis.kokonaisriskitaso <= 6.9 %}bg-warning text-dark{% else %}bg-danger{% endif %}">
                                                {{ analysis.risk_analysis.kokonaisriskitaso }}/10
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary">ei tietoa</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if analyses|length > 5 %}
                    <div class="text-center mt-3">
                        <a href="{{ url_for('list_analyses') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-list me-1"></i>Näytä kaikki analyysit
                        </a>
                    </div>
                    {% endif %}
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-search fa-3x mb-3 text-muted"></i>
                        <p class="mb-0">Et ole vielä tehnyt yhtään analyysia.</p>
                        <p class="text-muted">Syötä asuntoilmoituksen URL lomakkeeseen aloittaaksesi.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay">
    <div class="loading-spinner"></div>
    <h3 class="loading-text">Analysoidaan kohdetta...</h3>
    <p class="loading-subtext" id="loading-message">Tekoäly käy läpi asunnon tiedot ja muodostaa kokonaisvaltaisen analyysin. Tämä voi kestää hetken, joten ole hyvä ja odota.</p>
    <div class="loading-progress-container">
        <div class="loading-progress-bar"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('analyze-form');
    const urlInput = document.getElementById('url');
    const urlError = document.getElementById('url-error');
    const submitBtn = document.getElementById('submit-btn');
    const loadingOverlay = document.getElementById('loading-overlay');
    
    // Drag and drop elements
    const dragDropArea = document.getElementById('drag-drop-area');
    const fileInput = document.getElementById('file-input');
    const filePreview = document.getElementById('file-preview');
    const fileName = document.getElementById('file-name');
    const fileSize = document.getElementById('file-size');
    const fileRemove = document.getElementById('file-remove');
    let selectedFile = null;
    
    // Automaattinen tarkistus URL-kenttään kun käyttäjä syöttää tekstiä
    urlInput.addEventListener('input', function() {
        validateUrlField();
    });
    
    // Tarkista URL-kenttä kun käyttäjä poistuu siitä
    urlInput.addEventListener('blur', function() {
        if (urlInput.value.trim() !== '') {
            validateUrlField(true);
        }
    });
    
    // URL validointifunktio
    function validateUrlField(showError = false) {
        const url = urlInput.value.trim();
        const isValid = url && (url.includes('oikotie.fi') || url.includes('etuovi.com'));
        
        if (!isValid && showError) {
            urlInput.classList.add('is-invalid');
            urlError.classList.add('show');
        } else {
            urlInput.classList.remove('is-invalid');
            urlError.classList.remove('show');
        }
        
        return isValid;
    }
    
    // Handle form submission
    form.addEventListener('submit', function(e) {
        // Validate URL format
        if (!validateUrlField(true)) {
            e.preventDefault();
            return;
        }
        
        // Animaatio submit-painikkeeseen
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analysoidaan...';
        submitBtn.disabled = true;
        
        // Show loading overlay with slight delay for better UX
        setTimeout(() => {
            loadingOverlay.classList.add('show');
            
            // Aloita vaihtuva latausviestien näyttäminen
            startRotatingLoadingMessages();
        }, 300);
    });
    
    // Drag and drop functionality
    dragDropArea.addEventListener('click', function() {
        fileInput.click();
    });
    
    fileInput.addEventListener('change', function(e) {
        handleFileSelect(e.target.files);
    });
    
    // Drag and drop events
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dragDropArea.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        dragDropArea.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dragDropArea.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight() {
        dragDropArea.classList.add('dragover');
    }
    
    function unhighlight() {
        dragDropArea.classList.remove('dragover');
    }
    
    // Handle file drop
    dragDropArea.addEventListener('drop', function(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFileSelect(files);
    });
    
    // Process the selected file
    function handleFileSelect(files) {
        if (files.length === 0) return;
        
        const file = files[0];
        
        // Check if it's a PDF
        if (file.type !== 'application/pdf') {
            showNotification('Virhe', 'Ole hyvä ja valitse PDF-tiedosto.', 'error');
            return;
        }
        
        selectedFile = file;
        
        // Update the file preview
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        filePreview.style.display = 'flex';
        
        // Create a form data object to send to the server
        const formData = new FormData();
        formData.append('pdf_file', file);
        
        // Animaatio alueeseen
        dragDropArea.innerHTML = '<i class="fas fa-spinner fa-spin fa-2x mb-3"></i><p>Lähetetään tiedostoa...</p>';
        
        // Show loading overlay with slight delay for better UX
        setTimeout(() => {
            loadingOverlay.classList.add('show');
        }, 500);
        
        // Submit the file to the server
        fetch('{{ url_for("upload_pdf") }}', {
            method: 'POST',
            body: formData,
            credentials: 'same-origin'
        })
        .then(response => {
            // If we get a redirect, follow it
            if (response.redirected) {
                window.location.href = response.url;
                return;
            }
            
            // Otherwise, check for errors
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || 'Virhe tiedoston latauksessa');
                });
            }
            
            return response.text();
        })
        .catch(error => {
            loadingOverlay.classList.remove('show');
            showNotification('Virhe', error.message, 'error');
            resetFileUpload();
        });
    }
    
    // Handle file removal
    fileRemove.addEventListener('click', function() {
        resetFileUpload();
    });
    
    // Reset file upload area
    function resetFileUpload() {
        selectedFile = null;
        fileInput.value = '';
        filePreview.style.display = 'none';
        // Reset drag drop area content
        dragDropArea.innerHTML = `
            <div class="drag-drop-icon">
                <i class="fas fa-file-pdf"></i>
            </div>
            <p class="drag-drop-text">Raahaa ja pudota PDF-tiedosto tähän</p>
            <p class="drag-drop-subtext">tai <span class="text-primary">selaa tiedostoja</span></p>
            <p class="drag-drop-subtext mt-2">Hyväksytään Etuovi ja Oikotie PDF-esitteet</p>
        `;
    }
    
    // Custom notification function
    function showNotification(title, message, type = 'info') {
        // Tähän voi lisätä custom ilmoituskomponentin, kuten toast-ilmoituksen
        alert(`${title}: ${message}`);
    }
    
    // Helper function to format file size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // Lisää animaatioita sivulle
    function addPageAnimations() {
        // Animoi kortit näkyviin kun scrollataan
        const cards = document.querySelectorAll('.form-card, .info-card');
        
        // Tarkista jos IntersectionObserver on tuettu
        if ('IntersectionObserver' in window) {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                        observer.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.1 });
            
            cards.forEach(card => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                observer.observe(card);
            });
        }
    }
    
    // Kutsu animaatiofunktiota kun sivu on ladattu
    addPageAnimations();

    // Vaihtuvia latausviestejä varten
    function startRotatingLoadingMessages() {
        const loadingMessages = [
            "Haetaanpa hintatietoa, kaupankäynnin kalliskasta.",
            "Kysellähän kämppätietoa, turuilta ja toreilta.",
            "Lasketahan lainasummat, rahoituksen raamitukset.",
            "Luetaanpa ilmoitukset, myytävien maitten päältä.",
            "Nostetaan nyt neliöhinnat, punnitaanpa paikkakunnat.",
            "Mitataanpa myyntihinnat, huonehinnat huvitellaan.",
            "Otettahan Oikotieltä, asuntojen aartehia.",
            "Katsellaanpa kauppakirjat, lainhuudot ja lainatiedot.",
            "Kurkistetaan kulutukset, lämmön, veden, varjotusten.",
            "Kuunnellaanpa kuntotarkast, raporttien reunoilta.",
            "Lähdetähän liikkehelle, etsitähän ensikodit, myytävien maitten päältä.",
            "Nostetahan neliöhintoja, tarkastellaan tonttimaat, rannat, pellot, pientalotkin.",
            "Kaivetahan karttakuvat, maitten, teitten mittasuhteet, naapurusten näkymätkin.",
            "Lasketahan lämmitykset, katsotahan kulutukset, sähkölaskut selvitellään.",
            "Punnitaanpa paikkakunnat, katsotahan kaupunginosat, kukkulat ja kylänraitat.",
            "Haetaanpa hallintakirjat, tutkistellaan tonttijaot, perustiedot pureksitaan.",
            "Tutkitaanpa tontinrajoja, mittanauhat mittoillahan, nurkat nostetahan näkyviin.",
            "Rahoituksen raamituksia lasketahan laskin kädessä, sopimukset sovitahan.",
            "Lasketahan lainalyhenteet, kuukaudet kulutellaan, maksut maksutellaan muistiin.",
            "Kaivetahan kauppahinnat, luetaanpa luovutukset, puhalletaan pölyt päältä."
        ];

        const messageElement = document.getElementById('loading-message');
        let currentIndex = 0;
        
        // Näytä ensimmäinen viesti heti
        messageElement.textContent = loadingMessages[currentIndex];
        
        // Lisää pieni fade-efekti
        messageElement.style.transition = 'opacity 0.8s ease';
        
        // Aloita viestien kierto
        const messageRotationInterval = setInterval(() => {
            messageElement.style.opacity = '0';
            
            setTimeout(() => {
                // Odota 3 sekuntia ennen kuin näytetään seuraava viesti
                setTimeout(() => {
                    currentIndex = (currentIndex + 1) % loadingMessages.length;
                    messageElement.textContent = loadingMessages[currentIndex];
                    messageElement.style.opacity = '1';
                }, 3000); // 3 sekunnin tauko viestien välissä
            }, 800); // Odota fade-out -efektin ajan
            
        }, 15000); // Vaihda viesti 15 sekunnin välein
        
        // Tallenna interval globaaliin scopeen, jotta voimme pysäyttää sen myöhemmin
        window.messageRotationInterval = messageRotationInterval;
    }
    
    // Pysäytä viestien kierto kun poistutaan latausruudusta
    window.addEventListener('beforeunload', () => {
        if (window.messageRotationInterval) {
            clearInterval(window.messageRotationInterval);
        }
    });
});
</script>
{% endblock %} 